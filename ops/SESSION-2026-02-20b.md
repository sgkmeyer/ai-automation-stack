# Session Log — 2026-02-20 (Session 2)

## Scope

Environment hardening and dev/prod lane setup. All planned items from the
2026-02-20 session handoff completed.

---

## What Changed

### 1) Secrets Rotation

**POSTGRES_PASSWORD:**
- Generated new strong password on VM using `openssl rand`
- Ran `ALTER USER n8n_admin PASSWORD '...'` inside the running db container
- Updated `automation/.env` on VM via `sed`
- Recreated n8n and n8n-worker containers to pick up new env (restart alone
  does not reload env vars — `up -d` required)

**N8N_ENCRYPTION_KEY:**
- Generated new key on VM
- Updated `automation/.env` on VM
- Deleted `/home/node/.n8n/config` from the `automation_n8n_data` volume
  (via busybox container — direct volume access) so n8n regenerates it with
  the new key
- Restarted n8n — came up clean with new key
- Side effect: stored credentials encrypted with old key are unreadable;
  user to re-enter credentials in n8n UI
- Side effect: MFA secret was encrypted with old key; cleared via SQL:
  `UPDATE "user" SET "mfaEnabled"=false, "mfaSecret"=NULL, "mfaRecoveryCodes"=NULL`
  User to re-enroll MFA in n8n Settings → Personal → Two-factor authentication

**n8n license fingerprint warning:**
- n8n logs `cert is invalid because device fingerprint does not match` after
  config regeneration. Non-blocking; auto-resolves at next renewal (2026-02-26).

### 2) Gateway Token Verification

- Compared `OPENCLAW_GATEWAY_TOKEN` in `.env` against `gateway.auth.token` in
  `openclaw/config.json` via shell comparison (values not printed)
- Result: MATCH — no action needed. Previous "mismatch" note was stale.

### 3) Tailscale Authkey Rotation

- New reusable/ephemeral authkey created in Tailscale admin (expires 2026-05-21)
- Updated `TAILSCALE_AUTHKEY` GitHub secret
- Added `ephemeral: true` to both deploy workflows — then removed after
  discovering it is not a valid input for `tailscale/github-action@v2`
- OAuth migration deferred to May when key expires

### 4) Tailscale Local LaunchDaemon

- Created `scripts/com.tailscale.tailscaled.plist` — system LaunchDaemon that
  runs tailscaled as root at boot
- Created `scripts/setup-tailscale-daemon.sh` — one-time install script
- Fixed socket path after first attempt: plist used wrong path
  (`/var/run/tailscale/tailscaled.sock`); corrected to `/var/run/tailscaled.socket`
  to match what the tailscale CLI expects by default
- LaunchDaemon installed and verified: `tailscale status` shows both Mac and VM
- Updated `scripts/start-session.sh` to check Tailscale status at session start

### 5) Dev/Prod GitOps Lanes

- Created `scripts/gitops-deploy-dev.sh` — VM-side deploy script for dev stack
  (project name `automation-dev`, port 5679, separate volumes)
- Created `.github/workflows/deploy-dev.yml` — auto-deploys on push to `dev`,
  no approval gate, Tailscale smoke test via direct IP
- Created `dev` branch from `main`, pushed to GitHub
- First deploy run: failed with exit code 127 (ephemeral input issue + script
  not yet on VM). Fixed and re-ran — deploy green, smoke test green.
- VM public IP fallback (`ssh oracle`) used throughout session as Tailscale
  daemon was not yet set up

---

## Deployment Notes

- Deploy method: `ssh oracle` (public IP) — Tailscale not yet running at session start
- GitOps deploys triggered via push to `main` (prod) and `dev`

## Validation Checks Passed

- `https://n8n.satoic.com` → 200 ✅
- `https://openclaw.satoic.com` → 401 ✅
- `https://portainer.satoic.com` → 401 ✅
- Dev n8n `http://100.82.169.113:5679` → 200 (via Tailscale smoke test) ✅
- Tailscale daemon on Mac → connected, both peers visible ✅

## Backups Taken

- None this session (no structural changes requiring backup; secrets rotation
  is non-destructive to volume data)

## Known Risks / Notes

- **n8n credentials need re-entry** — all stored n8n credentials are
  unreadable after encryption key rotation; user must re-enter via UI
- **MFA needs re-enrollment** — cleared to allow login; re-enroll in n8n
  Settings → Personal → Two-factor authentication
- **n8n license fingerprint warning** — non-blocking, auto-resolves 2026-02-26
- **Tailscale OAuth** — deferred to May; authkey expires 2026-05-21

## SSH Context

- Used `ssh oracle` (public IP `40.233.119.194`) throughout — Tailscale daemon
  was being set up during the session
- By end of session Tailscale LaunchDaemon installed and working on Mac

---

## Next Session Plan

1. **Workflow #1** — Openclaw → n8n → Postgres leads pipeline (main build goal)
2. **n8n credential re-entry** — user to do before next session; note which
   credentials need to be re-added
3. **Pre-GitOps VM backup cleanup** — remove `/home/ubuntu/automation.pre-gitops-2026-02-16-2147`
   from VM (one more day confirmed healthy)
4. **SSH key rotation** — due ~2026-03-20; `satoic_operator` and `satoic_ci`
