# Session Log — 2026-02-24

## Scope
- Set up OPENAI_API_KEY for Openclaw container (TARS memory_search)
- Fixed SSH hostname mismatch (`satoic-vm` → `satoic-production`) across all scripts
- Discussed RAG architecture options, created design notes (deferred until concrete use case)
- Full infrastructure audit and stack upgrade: all services to latest
- n8n v1 → v2 major upgrade (dev-tested, then production deployed)

## What Changed
### 1) Infrastructure / Runtime
- **OPENAI_API_KEY passthrough**: Added `OPENAI_API_KEY=${OPENAI_API_KEY}` to openclaw service in `docker-compose.yml`
- **SSH hostname fix**: Renamed `satoic-vm` → `satoic-production` across 8 files (scripts, CLAUDE.md, runbooks)
- **n8n v1 → v2 upgrade**: Changed image tags from `n8nio/n8n:1` to `n8nio/n8n:latest` (v2.9.2) across n8n, n8n-worker, n8n-webhook
- **Task runner sidecar**: Added `n8n-task-runner` service (`n8nio/runners:latest`) required by n8n v2
- **New env vars**: `N8N_RUNNERS_MODE=external`, `N8N_RUNNERS_AUTH_TOKEN`, `N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0`, `N8N_DEFAULT_BINARY_DATA_MODE=database`, `CODE_ENABLE_PROCESS_ENV_ACCESS=true`
- **Removed deprecated**: `N8N_RUNNERS_ENABLED=true` (no longer needed in v2)
- **Portainer upgrade**: `portainer/portainer-ce:2.20.3` → `portainer/portainer-ce:lts`
- **Patch pulls**: Caddy 2-alpine, Postgres 16-alpine, Redis 7-alpine, Python 3.12-slim all pulled fresh
- Files: `automation/docker-compose.yml`, `automation/docker-compose.dev.yml`

### 2) Workflow / Application
- TARS memory_search now functional with OpenAI embeddings
- JS-01 workflow (id: `chwneHrHVCQON462`) verified active and working on n8n v2
- n8n v2 task runners registered: JS (1 runner) and Python (1 runner)

### 3) Operations / Docs
- Created `workflows/rag-design-notes.md` — pgvector + n8n architecture for future RAG
- Updated `ops/today.md` with new stack versions and service count (11)
- Updated `scripts/vm-safe.sh` — added `n8n-task-runner` to service allowlist, fixed hostname
- Updated `ops/runbooks.md` — hostname fix
- Updated `CLAUDE.md` — hostname fix in backup guardrails

## Deployment Notes
- Deploy method: GitOps (push → SSH → `gitops-deploy.sh`)
- VM apply performed: yes, multiple deploys throughout session
- Dev stack used for n8n v2 testing before production deploy

## Validation Checks Passed
- All 11 services healthy on production
- `https://n8n.satoic.com` → 200
- `https://openclaw.satoic.com` → 401 (expected)
- `https://portainer.satoic.com` → 401 (expected)
- n8n v2 UI loads, shows v2.9.2
- Task runners registered (JS + Python)
- JS-01 workflow active
- TARS memory_search confirmed working

## Backups Taken
- Config backup: yes (DR backup before n8n v2 upgrade)
- DB volume backup: yes (included in DR backup)

## Known Risks / Notes
- `vm-safe.sh dr-backup` tar doesn't follow symlinks (needs `-h` flag) — noted, not yet fixed
- `vm-safe.sh` usage text missing `n8n-task-runner` and `n8n-webhook` in allowlist display
- Dev stack torn down after upgrade testing
- Local `.env` missing `N8N_RUNNERS_AUTH_TOKEN` (only on VM) — should sync
- Secrets rotated: n/a

## Rollback / Recovery
- n8n v2: revert docker-compose.yml image tags to `n8nio/n8n:1`, remove task-runner service, redeploy. If DB incompatible, restore from DR backup taken pre-upgrade.
- Portainer: change tag back to `2.20.3`, redeploy.
- All other services: floating tags, just redeploy previous compose state from git history.

## Next Session Plan
1. Research n8n v2 features — specifically "Personal Agents" and "Workflow Agents" and how TARS could integrate
2. Fix `vm-safe.sh dr-backup` to use `tar -h` for symlink following
3. Fix `vm-safe.sh` usage text to include `n8n-task-runner` and `n8n-webhook`
4. Build MCP bridge (Path A): Python MCP server on Mac → Openclaw API over Tailscale
5. Test JS-01 end-to-end: `/lead <url>` → Openclaw → n8n → Postgres → HubSpot → Drive → Gmail
