# Session Log — 2026-02-20

## Scope

Completed the environment upgrade plan started 2026-02-19. Primary focus:
fix GitHub Actions CI/CD pipeline (yamllint + shellcheck errors) and get
the full GitOps deploy pipeline working end-to-end through Tailscale.

## What Changed

### 1) Infrastructure / Runtime

**CI pipeline fixed — yamllint errors in compose files:**
- `automation/docker-compose.yml` — added `---`, fixed `#note` comment spacing,
  reduced 3→2 blank lines at ~L154, removed 2 trailing blank lines at L324.
  (Changes were applied last session but not committed; committed this session.)
- `automation/docker-compose.dev.yml` — split long comment line >80 chars into two lines
- `automation/docker-compose.chromium-native.yml` — added `---`
- `automation/docker-compose.chromium-ip.yml` — added `---`

**CI pipeline fixed — shellcheck SC2029 in vm-safe.sh:**
- Two `ssh "${VM_HOST}"` calls were flagged for client-side variable expansion.
  Both are intentional. Suppressed with `# shellcheck disable=SC2029` directives
  preceded by explanation comments.

**Deploy workflow fixed — SSH key loading:**
- `deploy-prod.yml` was missing a step to load the SSH private key onto the runner.
  Added "Load SSH key" step using `printf` to write `VM_SSH_PRIVATE_KEY` to `~/.ssh/id_rsa`.

**Deploy workflow fixed — secret name mismatch:**
- Workflow referenced `secrets.VM_TAILSCALE_IP` but secret was configured as
  `VM_TAILSCALE_HOST` (value: `satoic-production`). Updated workflow to match.

**Deploy workflow — diagnostics added (kept):**
- "Verify Tailscale connection" step: runs `tailscale status` after connect — useful visibility
- `ssh-keygen -l` key fingerprint check in Load SSH key step

Files touched:
- `.github/workflows/deploy-prod.yml`
- `automation/docker-compose.yml`
- `automation/docker-compose.dev.yml`
- `automation/docker-compose.chromium-native.yml`
- `automation/docker-compose.chromium-ip.yml`
- `scripts/vm-safe.sh`

### 2) Workflow / Application

No workflow or application changes this session.

### 3) Operations / Docs

- `ops/today.md` — updated to reflect fully operational CI/CD pipeline

## Deployment Notes

- Deploy method used: GitOps (GitHub Actions → Tailscale SSH → gitops-deploy.sh)
- VM apply performed: yes — full GitOps deploy ran and smoke test passed

## Validation Checks Passed

- `yamllint automation/docker-compose*.yml` → exit 0 (2 style warnings only, non-blocking)
- `shellcheck scripts/*.sh` → exit 0
- GitHub Actions CI (`ci.yml`) → ✅ green on commit `ceab600`
- GitHub Actions deploy (`deploy-prod.yml`) → ✅ green on commit `c0f485b`
  - GitOps deploy: connected Tailscale, loaded SSH key, SSHed to `satoic-production`,
    ran `gitops-deploy.sh` successfully
  - Smoke test: `https://n8n.satoic.com` → 200, `https://openclaw.satoic.com` → 401,
    `https://portainer.satoic.com` → 401

## Backups Taken

- Config backup: no (DR backup requires Mac-side script run; not performed this session)
- DB volume backup: no

## Known Risks / Notes

- **Tailscale authkey deprecated** — warning on every deploy run. Migrate to OAuth client
  at tailscale.com/s/oauth-clients when convenient. Non-blocking for now.
- **`ssh-keygen -l` step** — prints key fingerprint to log (public info, not sensitive).
  Can be removed once deploy is confirmed stable.
- **Gateway token mismatch** — `automation/.env` OPENCLAW_GATEWAY_TOKEN differs from
  `automation/openclaw/config.json`; not addressed this session.
- **Placeholder secrets** — `POSTGRES_PASSWORD` and `N8N_ENCRYPTION_KEY` still use
  example-looking values; rotate before any production use.
- Secrets rotated: no / n/a

## Rollback / Recovery

- CI/CD workflows: revert `.github/workflows/` commit, push to main
- vm-safe.sh shellcheck disables: revert `scripts/vm-safe.sh` commit
- Compose yamllint fixes are cosmetic — safe to keep regardless
- Stack itself was not changed; no service restart needed

## SSH Key Changes (session addendum)

### Problem
`oracle_new` (RSA) was no longer accepted by the VM. `satoic_ci` (CI/CD key) was the
only working key — a bad state since CI and personal access were conflated.

### What changed
- Generated new personal operator key: `~/.ssh/satoic_operator` (ED25519)
- Added `satoic_operator` public key to VM `~/.ssh/authorized_keys`
- Updated `~/.ssh/config`:
  - `Host oracle` (public IP `40.233.119.194`) → now uses `satoic_operator`
  - `Host satoic-production` (Tailscale `100.82.169.113`) → now uses `satoic_operator`
- `oracle_new` fully retired
- `satoic_ci` left untouched — GitHub Actions CI/CD only

### Key inventory
| Key | Purpose |
|-----|---------|
| `satoic_operator` | Personal Mac→VM (both `ssh oracle` and `ssh satoic-production`) |
| `satoic_ci` | GitHub Actions CI/CD only (`VM_SSH_PRIVATE_KEY` secret) |
| `id_ed25519_github` | GitHub git operations only |

### Key rotation reminder
- **Next rotation due: ~2026-03-20** (4 weeks)
- Rotate `satoic_operator`: generate new key, add to authorized_keys, remove old entry, update config
- Rotate `satoic_ci`: generate new key, update GitHub secret `VM_SSH_PRIVATE_KEY`, update authorized_keys

---

## Next Session Plan

1. **Dev/prod GitOps lanes** — create `dev` branch + `deploy-dev.yml` workflow, start dev stack on VM
2. **Tailscale OAuth migration** — replace authkey with OAuth client ID/secret in deploy workflow
3. **Rotate secrets** — `POSTGRES_PASSWORD` and `N8N_ENCRYPTION_KEY` in `automation/.env` on VM
4. **Gateway token** — reconcile `OPENCLAW_GATEWAY_TOKEN` between `.env` and `openclaw/config.json`
5. **Workflow #1** — begin building Openclaw → n8n → Postgres pipeline
