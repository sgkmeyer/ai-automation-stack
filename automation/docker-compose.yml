---
services:
# note to self, we went with HTTP instead of HTTPs since we aren't doing DNS yet

  #############################################
  # EDGE / INGRESS
  #############################################
  # Caddy is the public-facing reverse proxy.
  #
  # Responsibilities:
  # - Terminates HTTPS (Let's Encrypt)
  # - Routes domains/subdomains to internal services
  # - Protects admin panels with auth
  #
  # Exposes ports 80/443 to the internet.
  #############################################
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Caddy routing rules
      - ./Caddyfile:/etc/caddy/Caddyfile:ro

      # Persistent TLS certs and config
      - caddy_data:/data
      - caddy_config:/config

    # Wait for backends so reverse proxy
    # doesn't point at a missing service
    depends_on:
      - n8n
      - openclaw
      - portainer


  #############################################
  # DATABASE
  #############################################
  # PostgreSQL stores:
  # - n8n workflows
  # - credentials (encrypted)
  # - execution logs
  # - state / history
  #
  # This is the MOST important data volume.
  # Must be backed up.
  #############################################
  db:
    image: postgres:16-alpine
    restart: unless-stopped

    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}

    volumes:
      # Persistent DB files
      - db_storage:/var/lib/postgresql/data

    # Healthcheck allows n8n to wait until DB is ready
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5


  #############################################
  # QUEUE / CACHE
  #############################################
  # Redis powers n8n's queue system.
  #
  # Why this exists:
  # - Enables background workers
  # - Handles concurrency
  # - Prevents long jobs blocking UI
  # - Allows retries + durability
  #############################################
  redis:
    image: redis:7-alpine
    restart: unless-stopped

    # Append-only file gives durability across restarts
    command: ["redis-server", "--appendonly", "yes"]

    volumes:
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5


  #############################################
  # N8N — MAIN ORCHESTRATOR NODE
  #############################################
  # This is the web UI + workflow scheduler.
  #
  # Responsibilities:
  # - User interface
  # - Workflow definitions
  # - Webhooks
  # - Dispatches jobs to workers
  #
  # DOES NOT execute heavy jobs directly —
  # those go to the worker container.
  #############################################
  n8n:
    image: n8nio/n8n:1
    restart: unless-stopped

    environment:
      # ---- Database config ----
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}

      # ---- Reverse proxy awareness ----
      # Needed so generated webhook URLs
      # and cookies work correctly behind HTTPS
      - N8N_HOST=${N8N_HOST}
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - N8N_PROXY_HOPS=1
      - WEBHOOK_URL=https://${N8N_HOST}/
      - N8N_EDITOR_BASE_URL=https://${N8N_HOST}/


      # ---- Queue / Worker mode ----
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379

      # ---- Credential encryption ----
      # MUST be long & random
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true

      - N8N_RUNNERS_ENABLED=true
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true

      # ---- App-level config ----
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - OPENCLAW_HOOK_TOKEN=${OPENCLAW_HOOK_TOKEN}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}

    volumes:
      # Stores workflows + config locally
      - n8n_data:/home/node/.n8n

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy


  #############################################
  # N8N — WORKER NODE
  #############################################
  # Executes queued jobs from Redis.
  #
  # You can scale this horizontally:
  # docker compose up --scale n8n-worker=3
  #
  # Heavy scraping / LLM calls should
  # happen here.
  #############################################
  n8n-worker:
    image: n8nio/n8n:1
    restart: unless-stopped

    command: ["worker"]

    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}

      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379

      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true

      # ---- App-level config ----
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - OPENCLAW_HOOK_TOKEN=${OPENCLAW_HOOK_TOKEN}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}

    volumes:
      - n8n_data:/home/node/.n8n

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy


  #############################################
  # N8N WEBHOOK — DEDICATED WEBHOOK LISTENER
  #############################################
  # Required in queue mode to register and
  # serve /webhook/ and /webhook-test/ URLs.
  # Without this, webhooks silently fail.
  #############################################
  n8n-webhook:
    image: n8nio/n8n:1
    restart: unless-stopped
    command: ["webhook"]

    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}

      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379

      - N8N_HOST=${N8N_HOST}
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - N8N_PROXY_HOPS=1
      - WEBHOOK_URL=https://${N8N_HOST}/
      - N8N_EDITOR_BASE_URL=https://${N8N_HOST}/

      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true

      - N8N_RUNNERS_ENABLED=true
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true

      # ---- App-level config ----
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - OPENCLAW_HOOK_TOKEN=${OPENCLAW_HOOK_TOKEN}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}

    volumes:
      - n8n_data:/home/node/.n8n

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy


  #############################################
  # OPENCLAW — AGENT / TOOL RUNTIME
  #############################################
  # Runs autonomous or semi-autonomous
  # AI agent workflows.
  #
  # n8n should orchestrate these,
  # not replace them.
  #############################################
  openclaw:
    build:
      context: ./openclaw-image
      dockerfile: Dockerfile
    image: satoic/openclaw-cap:latest
    restart: unless-stopped
    depends_on:
      - chromium
    environment:
      - NODE_ENV=production
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_CONFIG_PATH=/home/node/.openclaw/config.json
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - BROWSERLESS_TOKEN=${BROWSERLESS_TOKEN}
      - N8N_BASE_URL=http://n8n:5678
      - N8N_API_KEY=${N8N_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}

    volumes:
      - ./openclaw:/home/node/.openclaw
      # Read-only repo access for diagnostics (Option B)
      - /home/ubuntu/ai-automation-stack:/home/node/repo:ro

  #############################################
  # TOOLBOX CONTAINER
  #############################################
  # A permanent scripting sandbox.
  #
  # Used for:
  # - scraping
  # - PDF parsing
  # - custom Python jobs
  # - browser automation
  # - API glue scripts
  #
  # n8n can call into this via:
  # - webhooks
  # - docker exec
  #############################################
  toolbox:
    image: python:3.12-slim
    restart: unless-stopped
    volumes:
      - ./scripts:/app
    command: sleep infinity


  #############################################
  # PORTAINER — OPERATIONS DASHBOARD
  #############################################
  # Web UI for managing Docker.
  #
  # SECURITY NOTE:
  # - No public ports exposed
  # - Access only via Caddy or SSH tunnel
  #############################################
  portainer:
    image: portainer/portainer-ce:lts
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data

  #############################################
  # CHROMIUM — HEADLESS BROWSER RUNTIME
  #############################################
  # Isolated browser engine for Openclaw web tasks.
  #
  # Used for:
  # - web page rendering/scraping
  # - JavaScript-heavy site navigation
  # - deterministic browser automation
  #
  # SECURITY NOTE:
  # - No public ports exposed
  # - Internal Docker network access only
  # - Protected with Browserless token
  #############################################
  chromium:
    image: ghcr.io/browserless/chromium:latest
    restart: unless-stopped
    environment:
      - TOKEN=${BROWSERLESS_TOKEN}
      - CONCURRENT=5
      - TIMEOUT=120000
      - PREBOOT=true
      - ENABLE_DEBUGGER=false


#############################################
# PERSISTENT VOLUMES
#############################################
# These survive container restarts.
#
# db_storage     → PostgreSQL data
# reodis_data     → Redis queue
# n8n_data       → workflows/config
# caddy_data     → TLS certs
# caddy_config   → Caddy runtime state
# portainer_data → Portainer config
#############################################
volumes:
  db_storage:
  n8n_data:
  caddy_data:
  caddy_config:
  portainer_data:
  redis_data:
